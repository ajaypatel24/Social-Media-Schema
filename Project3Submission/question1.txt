-- FUNCTION: cs421g38.getquery(character varying, integer, character varying)

-- DROP FUNCTION cs421g38.getquery(character varying, integer, character varying);

CREATE OR REPLACE FUNCTION cs421g38.getquery(
	name character varying,
	id integer,
	date_before character varying)
    RETURNS SETOF soh 
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE 
    ROWS 1000
AS $BODY$

DECLARE 
  query_cursor CURSOR FOR SELECT first_name, page_id, date_string FROM interaction NATURAL JOIN accountuser NATURAL JOIN user_like WHERE first_name = name AND page_id = id AND date_string < date_before ORDER BY first_name;
  rec soh;
BEGIN
  OPEN query_cursor;
  FETCH query_cursor INTO rec.first_name, rec.page_id, rec.date_string;    -- Read a row from the cursor
  WHILE FOUND LOOP
    RETURN NEXT rec;                                 -- Return the data to the caller
    FETCH query_cursor INTO rec.first_name, rec.page_id, rec.date_string;  -- Keep on reading rows
  END LOOP;
  CLOSE query_cursor;
  RETURN;
END;
$BODY$;

ALTER FUNCTION cs421g38.getquery(character varying, integer, character varying)
    OWNER TO cs421g38;
